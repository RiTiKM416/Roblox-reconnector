<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Termux Reconnector — Admin</title>
    <style>
        /* Reset & base */
        :root {
            --bg: #071025;
            /* deep navy */
            --card: #0f1724;
            --muted: #89a0b3;
            --text: #e6eef6;
            --accent: #4f8ef7;
            --glass: rgba(255, 255, 255, 0.03);
            --success: #10b981;
            --danger: #ef4444;
            --border: rgba(255, 255, 255, 0.04);
            --glass-2: rgba(255, 255, 255, 0.02);
            --radius: 12px;
            font-synthesis: none;
        }

        * {
            box-sizing: border-box
        }

        html,
        body {
            height: 100%
        }

        body {
            margin: 0;
            font-family: Inter, ui-sans-serif, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
            background: linear-gradient(180deg, var(--bg) 0%, #04121f 100%);
            color: var(--text);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            padding: 28px;
        }

        .wrap {
            max-width: 1200px;
            margin: 0 auto
        }

        header.appbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 18px;
            border-radius: var(--radius);
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.02), rgba(255, 255, 255, 0.01));
            border: 1px solid var(--border);
            backdrop-filter: blur(8px);
            margin-bottom: 22px
        }

        .brand {
            display: flex;
            gap: 12px;
            align-items: center
        }

        .logo {
            width: 46px;
            height: 46px;
            border-radius: 10px;
            background: linear-gradient(135deg, var(--accent), #7cc3ff);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            color: #071025;
        }

        .brand h1 {
            font-size: 16px;
            margin: 0
        }

        .brand p {
            margin: 0;
            color: var(--muted);
            font-size: 12px
        }

        /* Stats grid */
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 14px;
            margin-bottom: 20px
        }

        .card {
            background: var(--card);
            padding: 14px;
            border-radius: 12px;
            border: 1px solid var(--border)
        }

        .stat-value {
            font-size: 20px;
            font-weight: 700
        }

        .stat-meta {
            color: var(--muted);
            font-size: 12px
        }

        /* Controls */
        .controls {
            display: flex;
            gap: 10px;
            align-items: center
        }

        .btn {
            padding: 8px 12px;
            border-radius: 8px;
            border: none;
            background: var(--accent);
            color: #04203b;
            font-weight: 700;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            font-size: 13px;
        }

        .btn.ghost {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text)
        }

        .btn.danger {
            background: transparent;
            border: 1px solid var(--danger);
            color: var(--danger)
        }

        .btn:hover {
            opacity: 0.8;
        }

        /* Table */
        .table-wrap {
            margin-top: 18px;
            background: linear-gradient(180deg, var(--glass), transparent);
            padding: 12px;
            border-radius: 12px;
            border: 1px solid var(--border)
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px
        }

        th,
        td {
            padding: 10px 12px;
            border-bottom: 1px solid var(--glass-2);
            text-align: left
        }

        th {
            font-size: 12px;
            color: var(--muted);
            font-weight: 700
        }

        tr:hover td {
            background: linear-gradient(90deg, rgba(255, 255, 255, 0.01), transparent)
        }

        .chip {
            display: inline-block;
            padding: 6px 8px;
            border-radius: 999px;
            font-size: 12px
        }

        .chip.ok {
            background: rgba(16, 185, 129, 0.12);
            color: var(--success)
        }

        .chip.bad {
            background: rgba(239, 68, 68, 0.08);
            color: var(--danger)
        }

        .chip.neutral {
            background: rgba(79, 142, 247, 0.12);
            color: var(--accent)
        }

        /* Alert */
        .alert {
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .alert.success {
            background: rgba(16, 185, 129, 0.12);
            border: 1px solid var(--success);
            color: var(--success);
        }

        .alert.error {
            background: rgba(239, 68, 68, 0.12);
            border: 1px solid var(--danger);
            color: var(--danger);
        }

        .close-btn {
            cursor: pointer;
            opacity: 0.7;
        }

        .close-btn:hover {
            opacity: 1;
        }

        /* Admin forms */
        .forms-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        .form-group {
            margin-bottom: 12px;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-size: 13px;
            color: var(--muted);
        }

        .form-group input {
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: rgba(0, 0, 0, 0.2);
            color: var(--text);
            font-family: inherit;
        }

        @media (max-width:720px) {
            header.appbar {
                flex-direction: column;
                gap: 12px;
                align-items: flex-start
            }

            .controls {
                width: 100%;
                justify-content: space-between
            }

            .forms-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>
    <div class="wrap">

        <% if (alert) { %>
            <div class="alert <%= alert.type === 'success' ? 'success' : 'error' %>" id="alertBox">
                <div><%- alert.message %></div>
                <div class="close-btn" onclick="document.getElementById('alertBox').style.display='none'">✕</div>
            </div>
            <% } %>

                <header class="appbar">
                    <div class="brand">
                        <div class="logo">TR</div>
                        <div>
                            <h1>Termux Reconnector — Admin</h1>
                            <p>Live device dashboard &amp; session controls</p>
                        </div>
                    </div>

                    <div class="controls">
                        <form action="/api/admin/create-instant-key" method="POST" style="margin:0;">
                            <button type="submit" class="btn">Gen Instant Key</button>
                        </form>
                        <form action="/api/bot/toggle" method="POST" style="margin:0;">
                            <button type="submit" class="btn ghost">
                                <%= state.botOnline ? 'Stop Bot' : 'Start Bot' %>
                            </button>
                        </form>
                    </div>
                </header>

                <!-- Stats -->
                <div class="stats">
                    <div class="card">
                        <div class="stat-value">
                            <%= state.totalKeysGenerated %>
                        </div>
                        <div class="stat-meta">Total Keys Issued</div>
                    </div>
                    <div class="card">
                        <div class="stat-value">
                            <%= activeCount %>
                        </div>
                        <div class="stat-meta">Active Subscriptions</div>
                    </div>
                    <div class="card">
                        <div class="stat-value">
                            <%= expiredCount %>
                        </div>
                        <div class="stat-meta">Expired Subscriptions</div>
                    </div>
                    <div class="card">
                        <div class="stat-value"><span class="chip <%= state.botOnline ? 'ok' : 'bad' %>">
                                <%= state.botOnline ? 'ONLINE' : 'OFFLINE' %>
                            </span></div>
                        <div class="stat-meta">Bot Status: <%= userTag %> (<%= guildCount %> servers)</div>
                    </div>
                </div>

                <!-- Device Table -->
                <div class="table-wrap card">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
                        <div style="display:flex;gap:8px;align-items:center">
                            <input id="q" placeholder="Search device, hwid, discord..."
                                style="padding:8px;border-radius:8px;border:1px solid var(--border);background:transparent;color:var(--text)"
                                oninput="renderFilter()">
                            <select id="filter"
                                style="padding:8px;border-radius:8px;border:1px solid var(--border);background:transparent;color:var(--text)"
                                onchange="renderFilter()">
                                <option value="all">All Statuses</option>
                                <option value="active">Active (24h)</option>
                                <option value="expired">Expired</option>
                            </select>
                        </div>
                        <div style="color:var(--muted);font-size:13px">Showing <span id="count">0</span> sessions</div>
                    </div>

                    <table id="devices-table">
                        <thead>
                            <tr>
                                <th>Discord Tag</th>
                                <th>HWID</th>
                                <th>Key / Validation</th>
                                <th>Last Synced</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>

                <!-- System Config Forms -->
                <div class="forms-grid">
                    <div class="card">
                        <h3 style="margin-top:0;font-size:16px;">System Config (Bypass Link)</h3>
                        <p style="color:var(--muted);font-size:13px;margin-bottom:15px;">Update the GUI Reconnector
                            script URL injected into the `setup` and `getscript` bot commands.</p>
                        <form action="/api/admin/update-embed" method="POST">
                            <div class="form-group">
                                <label>Title</label>
                                <input type="text" name="title" value="<%= embedConfig.title %>">
                            </div>
                            <div class="form-group">
                                <label>Script Raw Link (Important)</label>
                                <input type="text" name="bypassLink" value="<%= embedConfig.bypassLink %>">
                            </div>
                            <button type="submit" class="btn">Update System</button>
                        </form>
                    </div>

                    <div class="card">
                        <h3 style="margin-top:0;font-size:16px;">Quick Actions & Info</h3>
                        <p style="color:var(--muted);font-size:13px;margin-bottom:15px;">The HWID resets are executed
                            via Platoboost API. Network issues will show an error alert.</p>
                        <div
                            style="background:rgba(0,0,0,0.2);padding:15px;border-radius:8px;border:1px solid var(--border);font-family:monospace;font-size:12px;color:var(--muted);">
                            * HMAC-SHA256 signature enforcement: <span class="chip ok">ENABLED</span><br><br>
                            * Local SQLite Database sync: <span class="chip ok">HEALTHY</span><br><br>
                            * Discord Bot Instance: <span class="chip <%= state.botOnline ? 'ok' : 'bad' %>">
                                <%= state.botOnline ? 'CONNECTED' : 'HALTED' %>
                            </span>
                        </div>
                    </div>
                </div>
    </div>

    <script>
        const serverTime = Date.now();

        // Inject backend session data
        const rawDevices = <% - JSON.stringify(backupKeys || []) %>;

        // Process statuses based on timeMs
        const devices = rawDevices.map(d => {
            const ms_ago = serverTime - (d.timeMs || 0);
            const is_active = ms_ago < 86400000; // 24 hours
            const masked_key = (d.key && d.key.length > 8) ? d.key.substring(0, 4) + '••••••••' : d.key;
            return {
                ...d,
                status: is_active ? 'active' : 'expired',
                key_masked: masked_key,
                is_admin: d.key && d.key.startsWith('ADMIN_GEN_')
            };
        });

        function renderFilter() {
            const q = document.getElementById('q').value.toLowerCase();
            const f = document.getElementById('filter').value;
            const tbody = document.querySelector('#devices-table tbody');
            tbody.innerHTML = '';

            const filtered = devices.filter(d => {
                if (f !== 'all' && d.status !== f) return false;
                if (!q) return true;
                return (d.discordId || '').toLowerCase().includes(q) ||
                    (d.hwid || '').toLowerCase().includes(q) ||
                    (d.key || '').toLowerCase().includes(q);
            });

            document.getElementById('count').innerText = filtered.length;

            for (const d of filtered) {
                const tr = document.createElement('tr');
                const badge = d.status === 'active' ? '<span class="chip ok">Active</span>' : '<span class="chip bad">Expired</span>';
                const is_admin_badge = d.is_admin ? '<span class="chip neutral" style="margin-left:5px;">Admin</span>' : '';

                tr.innerHTML = `
          <td><strong>${d.discordId || '—'}</strong></td>
          <td style="font-family:monospace;font-size:12px;">${d.hwid}</td>
          <td style="font-family:monospace;font-size:12px;">${d.key_masked || '—'} ${is_admin_badge}</td>
          <td>${new Date(d.timeMs).toLocaleString()}</td>
          <td>${badge}</td>
          <td style="display:flex;gap:5px;">
            <form method="POST" action="/api/admin/reset-hwid" style="margin:0;" onsubmit="return confirm('Reset HWID for key ${d.key}?');">
              <input type="hidden" name="key" value="${d.key}">
              <button type="submit" class="btn ghost" style="padding:4px 8px;font-size:11px;">Reset HWID</button>
            </form>
            <form method="POST" action="/api/admin/delete-key" style="margin:0;" onsubmit="return confirm('Delete key ${d.key}?');">
              <input type="hidden" name="key" value="${d.key}">
              <button type="submit" class="btn danger" style="padding:4px 8px;font-size:11px;">Delete</button>
            </form>
          </td>
        `;
                tbody.appendChild(tr);
            }
        }

        // Initial render
        renderFilter();
    </script>
</body>

</html>